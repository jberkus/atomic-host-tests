---
# vim: set ft=ansible:
#
- name: Fail when package is undefined
  when: package is undefined
  fail:
    msg: "Package is undefined"

# This role provides the following variables:
#  - ros: result of 'rpm-ostree status --json'
#  - ros_json: ros.stdout piped through the from_json filter
#  - ros_num_deployments:  number of deployments on host
#  - ros_booted: JSON object of the booted deployment
#  - ros_not_booted: JSON object of the not booted deployment
- name: Get rpm-ostree status output
  import_role:
    name: rpm_ostree_status

- name: Set packages for booted deployment
  set_fact:
    installed_pkgs: "{{ ros_booted['packages'] }}"

- name: Fail if {{ package }} is not in rpm-ostree status output
  when: package not in installed_pkgs
  fail:
    msg: "{{ package }} not in rpm-ostree status output"

- name: Verify {{ package }} is installed
  command: command -v {{ package }}

- name: Verify {{ package }} in rpmdb
  command: rpm -q {{ package }}
